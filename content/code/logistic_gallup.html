---
title: "Logistic Regression in R: Catholic Opinions on Celibate Clergy"
author: John A. Bernau
date: "6/26/2018"
slug: logistic_gallup
categories: []
tags: []
---



<p><a name="top"></a> This post offers an example of performing logistic regression in R. I’ll cover the following topics:</p>
<div style="float:right;position: relative; top: -10px; left: 10px;">
<p><img src="http://prodimage.images-bn.com/pimages/9780316055697_p0_v5_s1200x630.jpg" height="400" /></p>
</div>
<ul>
<li><a href="#import">Importing data</a></li>
<li><a href="#prep">Preparing data</a></li>
<li><a href="#model">Fitting logistic model</a></li>
<li><a href="#coef">Interpreting Coefficients</a></li>
<li><a href="#fit">Assessing model fit</a></li>
<li>Generating predicted probabilities</li>
<li>Plotting!</li>
</ul>
<p>More specifically, I’ll be using the <a href="http://www.thearda.com/Archive/Files/Descriptions/GALLUP05.asp">2005 Gallup Poll of Catholics</a> hosted on the <a href="http://www.thearda.com/Archive/Files/Downloads/GALLUP05_DL2.asp">ARDA data archives</a>, to examine the factors that drive catholic opinion on the importance of celibate clergy. This issue became one of national importance when the Boston Globe unearthed the systematic abuse of minors by catholic clery in 2002 (as described in <a href="https://www.amazon.com/Betrayal-Catholic-findings-investigation-Spotlight/dp/0316271535">their Pulitzer-Prize-winning book</a>). Gallup conducted multiple waves of its catholic poll (1987, 1992, 1993, 1999, and 2005), but I’ll only focus on the most recent wave and set aside any questions of longitudinal trends for now.</p>
<p><strong><em>RQ: How is one’s support for priestly celibacy influenced by factors such as age, sex, politics, mass attendance, or education?</em></strong></p>
<hr />
<pre class="r"><code># Loading required pacakges:
require(&quot;tidyverse&quot;)
require(&quot;foreign&quot;)
require(&quot;broom&quot;)
require(&quot;RColorBrewer&quot;)
require(&quot;scales&quot;)</code></pre>
<hr />
<p><a name="import"></a> <strong>Importing Data</strong></p>
<hr />
<p>We’ll use <code>foreign::read.dta()</code> to read the labeled Stata file directly into R from it’s URL.</p>
<pre class="r"><code>gallup &lt;- read.dta(&quot;http://www.thearda.com/download/download.aspx?file=Gallup%20Poll%20of%20Catholics,%202005.DTA&quot;) %&gt;% 
  as_tibble()</code></pre>
<p>An initial glimpse gives us an idea of the 96 different variables, but we’ll need <a href="http://www.thearda.com/Archive/Files/Downloads/GALLUP05_DL2.asp">the codebook</a> to decipher which variables / responses are of interest.</p>
<hr />
<p><a name="prep"></a> <strong>Preparing Data</strong></p>
<hr />
<div style="text-align: right">
<a href="#top">Back to Top</a>
</div>
<p><br> I’ll be looking at six independent (or explanatory) variables: age, education, sex, political identification, mass attendance, and US geographic region. First, I remove any missing values or irrelevant categories. Second, I generate new variables and recode / collapse categories as appropriate. Lastly, I plot some descriptive graphs to examine our clean variables.</p>
<pre class="r"><code># Remove missing values
gallup &lt;- gallup %&gt;% 
  filter(!is.na(age),
         !is.na(educ),
         partyid == &quot;Republican&quot; | partyid == &quot;Democrat&quot; | partyid == &quot;Independent&quot;,
         attend != &quot;Don&#39;t know&quot;)

# Recoding education
gallup$educ2 &lt;- NA
gallup$educ2[gallup$educ == &#39;Less than a high school graduate (0-11)&#39;] &lt;- 1
gallup$educ2[gallup$educ == &#39;High school graduate (12)&#39;] &lt;- 2
gallup$educ2[gallup$educ == &#39;Trade/technical/vocational training&#39;] &lt;- 3
gallup$educ2[gallup$educ == &#39;Some college&#39;] &lt;- 3
gallup$educ2[gallup$educ == &#39;College graduate&#39;] &lt;- 4
gallup$educ2[gallup$educ == &#39;Postgraduate work or academic or professional degree&#39;] &lt;- 5

# Generate new factor labels for education
gallup$educ2 &lt;- factor(gallup$educ2, labels = c(&quot;Less than HS&quot;, &quot;High School&quot;, &quot;Trade / Some col&quot;, &quot;College&quot;, &quot;Professional&quot;))

# Remove any remaining NAs for education
gallup &lt;- gallup %&gt;% 
  filter(!is.na(educ2))

# Dichotomizing sex variable into &quot;female&quot;
gallup$female &lt;- NA
gallup$female[gallup$sex == &quot;Male&quot;] &lt;- 0
gallup$female[gallup$sex == &quot;Female&quot;] &lt;- 1</code></pre>
<p>Plotting a histogram of age, with vertical line at mean.</p>
<pre class="r"><code>ggplot(gallup, aes(age)) + 
  geom_histogram() +
  geom_vline(xintercept = mean(gallup$age), color = &quot;red&quot;)</code></pre>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="/code/logistic_gallup_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>Plotting a bar chart of education, filled according to sex.</p>
<pre class="r"><code>ggplot(gallup, aes(educ2)) + 
  geom_bar(aes(fill=factor(female)), stat=&quot;count&quot;, position=&quot;dodge&quot;) + 
  coord_flip()</code></pre>
<p><img src="/code/logistic_gallup_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>Our prepared dataset should have 819 observations of 98 variables after cleaning measures of age, education, sex, attendance, political identification and US region.</p>
<pre class="r"><code># A marginally helpful heatmap of four categorical variables
ggplot(gallup, aes(partyid, attend)) +
  geom_tile(alpha=0.1, fill = &quot;darkblue&quot;) +
  facet_grid(sex~region) +
  theme(axis.text.x = element_text(angle = 60, vjust = 0.5))</code></pre>
<p><img src="/code/logistic_gallup_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>Moving to our dependent variable, we have a four-category response to the question:</p>
<blockquote>
<p>As a Catholic, how important is each of the following to you? Would you say the following is or are very important, somewhat important, or not important at all? E. A celibate male clergy</p>
</blockquote>
<pre class="r"><code>table(gallup$celclerg)</code></pre>
<pre><code>## 
## Not important at all   Somewhat important       Very important 
##                  348                  245                  220 
##           Don&#39;t know 
##                    6</code></pre>
<p>Because we’re using a logistic regression, our response must be in binary form. Ideally, we would use a multinomial model to preserve the variation given by a three-level variable, but for our purposes, we’ll collapse into two categories along an “important” / “not important” dichotomy. We could also reasonably drop the “somewhat important” category to leave just those that feel strongly either way. No matter the decision, make sure to justify your rationale!</p>
<pre class="r"><code># Initialize new variable &quot;celimp&quot;
gallup$celimp &lt;- NA

# Recode 
gallup$celimp[gallup$celclerg == &#39;Not important at all&#39;] &lt;- 0
gallup$celimp[gallup$celclerg == &#39;Somewhat important&#39;] &lt;- 1
gallup$celimp[gallup$celclerg == &#39;Very important&#39;] &lt;- 1

# Filter only those in our new categories
gallup &lt;- filter(gallup, celimp == 0 | celimp == 1)</code></pre>
<p>Our prepared dataset should have 813 observations of 99 variables after cleaning measures of our dependent variable <code>celimp</code> : “importance of celibate clergy.”</p>
<hr />
<p><a name="model"></a> <strong>Fitting Logistic Model</strong></p>
<hr />
<div style="text-align: right">
<a href="#top">Back to Top</a>
</div>
<p><br> With a clean dataset, we can run our logistic model with the following code. Make sure to specify which variables to treat as categorical using the <code>factor()</code> notation.</p>
<pre class="r"><code>model &lt;- glm(celimp ~ female + factor(educ2) + age + factor(partyid) + factor(region) + factor(attend), data = gallup, family = binomial(&quot;logit&quot;))</code></pre>
<p>Our logistic model is now saved as an object in R. Using base R, we can print a summary to the console with the following code. [Output omitted]</p>
<pre class="r"><code>summary(model)</code></pre>
<p>One thing we may want to change is the reference category of a categorical variable. By default, R chooses the first category, but you can set this to a specific value using the following code. In our case, each education category is tested against “Less than HS.” Because this accounts for only a small number of our respondents, I change the reference category to catholics with a college education.</p>
<pre class="r"><code>gallup$educ2 &lt;- relevel(gallup$educ2, ref = &quot;College&quot;)

model &lt;- glm(celimp ~ female + factor(educ2) + age + factor(partyid) + factor(region) + factor(attend), data = gallup, family = binomial(&quot;logit&quot;))

# summary(model)</code></pre>
<p>Before turning to coefficients, we can get an overall sense of model-fit using <code>glance()</code> from the <code>broom</code> package. This reports overall log-Likelihood as well as AIC and BIC fit statistics.</p>
<pre class="r"><code>glance(model)</code></pre>
<pre><code>##   null.deviance df.null   logLik      AIC      BIC deviance df.residual
## 1      1110.161     812 -500.956 1033.912 1109.124 1001.912         797</code></pre>
<hr />
<p><a name="coef"></a> <strong>Interpreting Coefficients</strong></p>
<hr />
<div style="text-align: right">
<a href="#top">Back to Top</a>
</div>
<p><br> Before turning to substantive interpretation, let’s get our model in a readable format. As <a href="http://varianceexplained.org/r/broom-intro/">David Robinson notes</a>, the printed summary isn’t exactly a format we’re used to working with. Luckily the <code>broom</code> package converts statistical models into tidy data frames. Feeding our model through <code>tidy()</code> gives us a data frame for our coefficients, with each row corresponding to a regression term and each column providing a generated statistic: slope estimate, standard error, p-values, confidence intervals, etc.</p>
<pre class="r"><code>mod_coef &lt;- tidy(model, conf.int = TRUE)</code></pre>
<p>It may not look like much of a difference, but once in this format, we can apply all our tidy functions to the results of our model. For example, let’s examine a plot of our coefficient estimates.</p>
<pre class="r"><code>ggplot(mod_coef, aes(estimate, term, color = term)) +
  geom_point() +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high)) +
  geom_vline(xintercept = 0) +
  scale_color_discrete(guide = FALSE)</code></pre>
<p><img src="/code/logistic_gallup_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
<p>By including both the estimate and their confidence intervals using <code>geom_errorbarh()</code> this simple plot shows us most of the important output of our statistical model! By tweaking the ggplot code, we can start to see the benefit of this format.</p>
<ul>
<li>Present estimates as odds ratios: OR = exp(estimate)</li>
<li>Present estimates as percent change: per_change = (OR - 1) * 100</li>
<li>Color by size of estimate, p-value, or any other grouping</li>
</ul>
<p>Coloring by p-value, with darker plots corresponding to “more significant” estiamtes, is especially appealing by underscoring the importance of treating significance tests as a contiuum rather than a binned range of “significant” and “non-significant” values. See <a href="http://www.jayskaufman.com/uploads/3/0/8/9/30891283/sterne_&amp;_davey_smith_whats_wrong_with_significance_tests_bmj.pdf">Sterne &amp; Smith 2001</a>.</p>
<p>Below, I express estimates in terms of percentage change: “For every one-unit increase in X, respondents are Y% more likely to say celibate clergy are important.” Or for our categorical variables: “Compared to someone in category A, someone in category B is Y% more likely to say celibate clergy are important.” Subtracting one from our odds ratios and multiplying by 100 gives us this measure.</p>
<p>Most of the preparation below is reordering the regression terms in logical way. First, I add four reference categories as <code>refs</code> and row-bind these to the existing data.frame <code>mod_coef</code>. Then I prepare our <code>terms</code> variable for cleaner plotting: remove messy prefixes, group by variable, and reorder the levels. The plot colors each set of coefficients by its parent variable and displays a text label of the estimate if the confidence intervals clear the null value.</p>
<pre class="r"><code># Tidy estimates + new variables
mod_coef &lt;- tidy(model, conf.int = TRUE) %&gt;% 
  mutate(OR = exp(estimate),
         OR_ll = exp(conf.low),
         OR_ul = exp(conf.high),
         sig = ifelse(OR_ll &lt; 1 &amp; OR_ul &lt;1 | OR_ll &gt;1 &amp; OR_ul &gt;1, 
                      1, 
                      0),
         per_change = (OR-1)*100,
         per_ll = (OR_ll-1)*100,
         per_ul = (OR_ul-1)*100)

# Add reference categories for plotting
refs &lt;- data.frame(term = c(&quot;East&quot;, &quot;Republican&quot;, &quot;College&quot;, &quot;Weekly&quot;), 
                   per_change = c(0,0,0,0))
# Row-bind
require(plyr)
require(dplyr)
plot &lt;- rbind.fill(mod_coef, refs)

# Prepare terms for plotting
# Remove &quot;factor&quot;&quot; prefix
plot$term &lt;- str_replace_all(plot$term, &quot;factor&quot;, &quot;&quot;)

# Generate &quot;vars&quot; to distinguish groups of categorical terms
plot$vars &lt;- &quot;rest&quot;
plot$vars[plot$term == &quot;Weekly&quot;] &lt;- &quot;attend&quot;
plot$vars[str_detect(plot$term, &quot;attend&quot;)] &lt;- &quot;attend&quot;
plot$vars[plot$term == &quot;East&quot;] &lt;- &quot;region&quot;
plot$vars[str_detect(plot$term, &quot;region&quot;)] &lt;- &quot;region&quot;
plot$vars[plot$term == &quot;Republican&quot;] &lt;- &quot;party&quot;
plot$vars[str_detect(plot$term, &quot;partyid&quot;)] &lt;- &quot;party&quot;
plot$vars[plot$term == &quot;College&quot;] &lt;- &quot;educ&quot;
plot$vars[str_detect(plot$term, &quot;educ2&quot;)] &lt;- &quot;educ&quot;

# Remove prefixes from term labels
plot$term &lt;- str_replace_all(plot$term, &quot;\\(attend\\)&quot;, &quot;&quot;)
plot$term &lt;- str_replace_all(plot$term, &quot;\\(region\\)&quot;, &quot;&quot;)
plot$term &lt;- str_replace_all(plot$term, &quot;\\(partyid\\)&quot;, &quot;&quot;)
plot$term &lt;- str_replace_all(plot$term, &quot;\\(educ2\\)&quot;, &quot;&quot;)
plot$term &lt;- str_replace_all(plot$term, &quot;\\(Intercept\\)&quot;, &quot;Intercept&quot;)

# Reorder the levels of our factor
plot$term &lt;- factor(plot$term, levels = c(&quot;East&quot;, &quot;Midwest&quot;, &quot;West&quot;, &quot;South&quot;, &quot;Weekly&quot;, &quot;Two or three times a month&quot;, &quot;About once a month&quot;, &quot;A few times a year&quot;, &quot;Seldom or never&quot;, &quot;Republican&quot;, &quot;Democrat&quot;, &quot;Independent&quot;, &quot;Less than HS&quot;, &quot;High School&quot;, &quot;Trade / Some col&quot;, &quot;College&quot;, &quot;Professional&quot;, &quot;female&quot;, &quot;age&quot;, &quot;Intercept&quot;))</code></pre>
<pre class="r"><code># Plotting
ggplot(plot, aes(per_change, fct_rev(term), color = vars)) +
  geom_point(size = 2) +
  geom_errorbarh(aes(xmin = per_ll, xmax = per_ul)) +
  geom_text(aes(label = ifelse(sig == 1, round(per_change, 2), &quot;&quot;)), 
            nudge_x = -50) +
  geom_vline(xintercept = 0) +
  scale_x_continuous(limits = c(-150,150), 
                     breaks = seq(from = -150, to = 150, by = 50)) +
  scale_color_brewer(palette = &quot;Set1&quot;, guide = FALSE) +
  labs(x = &quot;Percent Change in Pr(DV)&quot;, y = &quot;&quot;, 
       title = &quot;Celibate Clergy as \&quot;Very Important\&quot;&quot;, 
       subtitle = &quot;Logistic Regression estimates&quot;, 
       caption = &quot;\nData source: Gallup Poll of Catholics 2005&quot;) +
   theme(text=element_text(size = 14, family=&quot;Times New Roman&quot;),
        axis.text = element_text(size = 10),
        plot.caption = element_text(size = 9),
        panel.background = element_rect(fill=&quot;white&quot;),
        panel.grid.minor = element_line(color=&quot;grey90&quot;),
        panel.grid.major = element_line(color=&quot;grey90&quot;),
        plot.margin = unit(c(0.5,0.5,0.5,0.5), &quot;cm&quot;))</code></pre>
<p><a href="/code/lr_gall.jpg"><img src = "/code/lr_gall.jpg" height = "650" align="left"></a></p>
<p>Thus, we can easily see the attendance measures in red, the political measures in green, and the education in blue, with each reference category sitting on the 0% change line. This allows an intuitive way to see the effect of moving between each category. Compared to a republican, a catholic democrat is 35.37% less likely to say celibate clergy are “very important.” Compared to a college-educated catholic, those with a professional degree are 46.93% less likely to say celibate clergy are “very important.” Remember, these estimates emerge after controlling for every other variable in the model. The effect of education is independent of political identification or attendance.</p>
<p>STOPPED HERE….</p>
<pre class="r"><code>#####################
# AUGMENT function
#####################
# Create dataframe with fitted values (in proportions) plus residuals and stuff
aug_mod &lt;- augment(model, type.predict = &quot;response&quot;)

aug_mod &lt;- augment(model)

head(aug_mod)</code></pre>
<pre><code>##   celimp female    factor.educ2. age factor.partyid. factor.region.
## 1      1      0          College  76        Democrat        Midwest
## 2      1      1      High School  58     Independent           East
## 3      1      1      High School  45      Republican        Midwest
## 4      1      1 Trade / Some col  67      Republican          South
## 5      1      1     Professional  57        Democrat        Midwest
## 6      0      0          College  81        Democrat           East
##         factor.attend.   .fitted   .se.fit     .resid       .hat   .sigma
## 1 At least once a week 0.9432673 0.2789298  0.8109730 0.01569310 1.121536
## 2 At least once a week 0.7237658 0.2877084  0.8892274 0.01820414 1.121460
## 3      Seldom or never 0.5364398 0.3027724  0.9596615 0.02134501 1.121384
## 4 At least once a week 1.4594938 0.2714668  0.6464148 0.01127491 1.121674
## 5 At least once a week 0.2196332 0.2338911  1.0856780 0.01351265 1.121241
## 6 At least once a week 0.6545354 0.2800652 -1.4649488 0.01765025 1.120687
##        .cooksd .std.resid
## 1 0.0003941594  0.8174122
## 2 0.0005723745  0.8974335
## 3 0.0008145997  0.9700704
## 4 0.0001674912  0.6500900
## 5 0.0006967101  1.0930884
## 6 0.0021996812 -1.4780508</code></pre>
<pre class="r"><code>ggplot(aug_mod, aes(.resid, .fitted)) +
  geom_point()</code></pre>
<p><img src="/code/logistic_gallup_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<pre class="r"><code>################################
# Generate binary predictions
aug_mod &lt;- aug_mod %&gt;% 
  mutate(celimp_hat = round(.fitted))

# Confusion matrix
cm &lt;- aug_mod %&gt;% 
  select(celimp, celimp_hat) %&gt;% 
  table() %&gt;% 
  addmargins()
cm</code></pre>
<pre><code>##       celimp_hat
## celimp  -2  -1   0   1   2 Sum
##    0    11  84 160  89   4 348
##    1     1  37 165 229  33 465
##    Sum  12 121 325 318  37 813</code></pre>
<pre class="r"><code># Sensitivity is the true positive rate. Predicted positives / Actual positives.
# 172/220 = 0.78
tpr &lt;- cm[3,2] / cm[2,3]
x &lt;- paste(&quot;True positive rate =&quot;, round(tpr, 3))

# Specificity is the true negative rate. Predicted negatives / actual negatives. 
# 396 / 348 = 1.14
tnr &lt;- cm[3,1] / cm[1,3]
y &lt;- paste(&quot;True negative rate =&quot;, round(tnr, 3))

# Overall
overall &lt;- (cm[1,1] + cm[2,2]) / cm[3,3]
z &lt;- paste(&quot;Overall accuracy =&quot;, round(overall, 3))

# Generate new variable: right or wrong
aug_mod &lt;- aug_mod %&gt;% 
  mutate(correct = ifelse(celimp == celimp_hat, 1, 0))

# Plotting stuff
ggplot(aug_mod, aes(factor.attend., .fitted)) +
  geom_jitter(width = 0.05, 
              alpha = 0.5, 
              aes(color = correct))</code></pre>
<p><img src="/code/logistic_gallup_files/figure-html/unnamed-chunk-17-2.png" width="672" /></p>
